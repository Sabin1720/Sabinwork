<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Anomaly Detector — Chart.js Enhanced</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--accent:#106fa4;--anomaly:#ff4c4c;--bg:#f7fbff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0;background:var(--bg);color:#063}
header{background:white;padding:14px 18px;border-bottom:1px solid #e6eef6}
.container{max-width:1400px;margin:18px auto;padding:12px; display:flex; gap:12px;}
.left-panel{flex:0 0 25%; display:flex; flex-direction:column; gap:8px;}
.right-panel{flex:1; display:flex; flex-direction:column; gap:8px;}
select,input,button{padding:8px;border:1px solid #cfe6f6;border-radius:6px;font-size:14px}
button{background:var(--accent);color:white;border:none;cursor:pointer}
button.secondary{background:white;color:var(--accent);border:1px solid #cfe6f6}
.summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.summary .item{background:#f0fbff;padding:8px;border-radius:6px;font-size:13px}
#chartContainer{background:white;border-radius:6px;border:1px solid #eef7ff;width:100%;height:500px; display:block;}
.table-wrap{overflow:auto;max-height:300px;border:1px solid #e6eef6; display:none;}
table{border-collapse:collapse;width:100%}
th,td{padding:6px 8px;border-bottom:1px solid #f0f6fb;text-align:left;font-size:13px}
tr.anomaly{background:var(--anomaly)}
.spinner{position:fixed;right:16px;bottom:16px;background:var(--accent);color:white;padding:10px;border-radius:50%;display:none}
</style>
</head>
<body>
<header>
<div class="container"><h1>Anomaly Detector — Chart.js Enhanced</h1></div>
</header>
<main class="container">
  <div class="left-panel">
    <label for="file">Browse file</label>
    <input id="file" type="file" accept=".csv,.json" />

    <label for="colSelect">Choose column</label>
    <select id="colSelect"></select>

    <label for="zThreshold">Z-Score threshold</label>
    <input id="zThreshold" type="number" value="3" step="0.1" min="0.1" />

    <label for="iqrMult">IQR multiplier</label>
    <input id="iqrMult" type="number" value="1.5" step="0.1" min="0" />

    <button id="detectBtn">Detect anomalies</button>
    <button id="showAnom" class="secondary">Show anomalies only</button>

    <button id="downloadCleaned" class="small">Download cleaned CSV</button>
    <button id="downloadAnoms" class="small secondary">Download anomalies CSV</button>

    <div class="summary" aria-live="polite">
      <div class="item">Total rows: <span id="totalRows">0</span></div>
      <div class="item">Anomalies: <span id="numAnoms">0</span></div>
      <div class="item">Analyzed column: <span id="analyzedCols">-</span></div>
    </div>

    <label for="viewMode">View</label>
    <select id="viewMode">
      <option value="table">Table</option>
      <option value="chart">Chart</option>
    </select>

    <div id="chartTypeContainer" style="display:none;">
      <label for="chartType">Chart Type</label>
      <select id="chartType">
        <option value="line">Line</option>
        <option value="scatter">Scatter</option>
        <option value="bar">Histogram</option>
      </select>
    </div>
  </div>

  <div class="right-panel">
    <div id="chartContainer">
      <canvas id="chartCanvas"></canvas>
    </div>
    <div class="table-wrap" id="dataTableWrap">
      <table id="dataTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<div class="spinner" id="spinner">⟳</div>

<script>
// --- Utility ---
function $(id){return document.getElementById(id);}
function showSpinner(show){$('spinner').style.display=show?'block':'none';}
function parseCSV(text){
  const rows=[]; let cur=''; let row=[]; let inQuotes=false;
  for(let i=0;i<text.length;i++){const ch=text[i]; const nxt=text[i+1];
    if(ch==='"'){ if(inQuotes && nxt==='"'){ cur+='"'; i++; continue;} inQuotes=!inQuotes; continue;}
    if(ch==='\r') continue;
    if(ch===',' && !inQuotes){ row.push(cur); cur=''; continue; }
    if(ch==='\n' && !inQuotes){ row.push(cur); rows.push(row); row=[]; cur=''; continue; }
    cur+=ch;
  }
  if(cur!=='' || row.length>0){ row.push(cur); rows.push(row);}
  return rows;
}
function detectHeader(rows){ if(rows.length<2) return true; const first=rows[0], second=rows[1]; let votes=0;
  for(let i=0;i<first.length;i++){ const a=first[i].trim(); const b=(second[i]||'').trim(); if(a==='' && b!=='') votes++; else if(isNaN(Number(a)) && !isNaN(Number(b))) votes++;} return votes>0;
}
function rowsToObjects(rows, header){ const data=[]; for(let r=0;r<rows.length;r++){ const row=rows[r]; const obj={}; for(let c=0;c<header.length;c++){ obj[header[c]] = row[c]!==undefined? row[c] : ''; } data.push(obj);} return data; }
function coerceRow(obj){ const out={}; for(const k in obj){ const v=obj[k]; const n=Number(v); out[k]=(!isNaN(n) && v.toString().trim()!=='')? n : v; } return out; }
function mean(arr){return arr.reduce((s,v)=>s+v,0)/arr.length;}
function std(arr){const m=mean(arr);return Math.sqrt(arr.reduce((s,v)=>s+(v-m)*(v-m),0)/arr.length);}
function quantile(sorted,q){const pos=(sorted.length-1)*q; const base=Math.floor(pos); const rest=pos-base; return sorted[base+1]!==undefined ? sorted[base]+rest*(sorted[base+1]-sorted[base]) : sorted[base];}
function computeIQRStats(arr){const sorted=arr.slice().sort((a,b)=>a-b); const q1=quantile(sorted,0.25); const q3=quantile(sorted,0.75); return {q1,q3,iqr:q3-q1};}

// --- State ---
let originalData=[], workingData=[], anomalyFlags=[], header=[], filenameBase='dataset';
let chartInstance=null;

// --- UI ---
const fileInput=$('file'), colSelect=$('colSelect'), zThreshold=$('zThreshold'), iqrMult=$('iqrMult');
const detectBtn=$('detectBtn'), showAnom=$('showAnom'), downloadCleaned=$('downloadCleaned'), downloadAnoms=$('downloadAnoms');
const totalRows=$('totalRows'), numAnoms=$('numAnoms'), analyzedCols=$('analyzedCols');
const viewMode=$('viewMode'), chartTypeContainer=$('chartTypeContainer'), chartType=$('chartType');
const chartCanvas=$('chartCanvas'), dataTableWrap=$('dataTableWrap'), thead=$('thead'), tbody=$('tbody');

fileInput.addEventListener('change', handleFile);
detectBtn.addEventListener('click', detectAnomalies);
showAnom.addEventListener('click', ()=>filterView(true));
downloadCleaned.addEventListener('click', ()=>downloadCSV(getCleanedData(), filenameBase+'_cleaned.csv'));
downloadAnoms.addEventListener('click', ()=>downloadCSV(getAnomaliesData(), filenameBase+'_anomalies.csv'));
viewMode.addEventListener('change', updateRightPanel);
chartType.addEventListener('change', renderChart);

// --- File handling ---
function handleFile(e){
    const file = e.target.files[0]; if(!file) return;
    filenameBase = (file.name||'dataset').replace(/\.[^.]+$/,''); showSpinner(true);
    const reader = new FileReader();
    reader.onload = function(ev){
        const text=ev.target.result;
        try{
            if(file.type.includes('json') || file.name.toLowerCase().endsWith('.json')){
                loadFromJSON(JSON.parse(text));
            } else { loadFromRows(parseCSV(text)); }
        } catch(err){console.error('Error parsing file: '+err);}
        finally{showSpinner(false);}
    }
    reader.readAsText(file);
}

function loadFromJSON(obj){ if(!Array.isArray(obj)) return; originalData=obj.map(coerceRow); workingData=originalData.slice(); header=Object.keys(originalData[0]||{}); anomalyFlags=new Array(workingData.length).fill(false); updateUI(); }
function loadFromRows(rows){ if(rows.length===0) return;
    let hasHeader = detectHeader(rows);
    if(hasHeader){ header=rows[0].map(h=>h.toString()); originalData=rowsToObjects(rows.slice(1),header).map(coerceRow); }
    else { header=[]; for(let i=0;i<rows[0].length;i++) header.push('col'+(i+1)); originalData=rowsToObjects(rows,header).map(coerceRow);}
    workingData=originalData.slice(); anomalyFlags=new Array(workingData.length).fill(false); updateUI();
}

function updateUI(){ colSelect.innerHTML=''; header.forEach(h=>{const opt=document.createElement('option'); opt.value=h; opt.textContent=h; colSelect.appendChild(opt);}); renderTable(); totalRows.textContent=workingData.length; numAnoms.textContent='0'; analyzedCols.textContent='-'; }

// --- Detection ---
function detectAnomalies(){
    if(workingData.length===0) return;
    const col = colSelect.value; if(!col) return;
    const zT=Number(zThreshold.value)||3; const iqrM=Number(iqrMult.value)||1.5;
    const vals = workingData.map(r=>Number(r[col])).filter(v=>!isNaN(v));
    if(vals.length===0) return;
    const m=mean(vals), s=std(vals), {q1,q3,iqr}=computeIQRStats(vals);
    anomalyFlags=workingData.map(r=>{
        const v=Number(r[col]);
        if(isNaN(v)) return false;
        let zFlag=Math.abs((v-m)/s)>zT, iqrFlag=v<q1-iqrM*iqr||v>q3+iqrM*iqr;
        return zFlag||iqrFlag;
    });
    updateSummary(col);
    renderTable(); renderChart();
}

function updateSummary(col){ totalRows.textContent=workingData.length; numAnoms.textContent=anomalyFlags.filter(Boolean).length; analyzedCols.textContent=col; }

// --- Table ---
function renderTable(showOnlyAnoms=false){
    thead.innerHTML=''; tbody.innerHTML='';
    const tr=document.createElement('tr'); header.forEach(h=>{const th=document.createElement('th'); th.textContent=h; tr.appendChild(th);}); thead.appendChild(tr);
    for(let i=0;i<workingData.length;i++){
        if(showOnlyAnoms && !anomalyFlags[i]) continue;
        const row=workingData[i]; const trr=document.createElement('tr'); if(anomalyFlags[i]) trr.classList.add('anomaly');
        for(const h of header){ const td=document.createElement('td'); td.textContent=row[h]; trr.appendChild(td);}
        tbody.appendChild(trr);
    }
}

// --- View ---
function filterView(showOnly){ renderTable(showOnly); if(viewMode.value==='chart') renderChart();}
function updateRightPanel(){
    if(viewMode.value==='chart'){ dataTableWrap.style.display='none'; chartCanvas.parentElement.style.display='block'; chartTypeContainer.style.display='block'; renderChart();}
    else { chartCanvas.parentElement.style.display='none'; chartTypeContainer.style.display='none'; dataTableWrap.style.display='block'; renderTable();}
}

// --- Chart.js ---
function renderChart(){
    const col=colSelect.value;
    const vals = workingData.map((r,i)=>({v:Number(r[col]),i})).filter(o=>!isNaN(o.v));
    if(vals.length===0) { if(chartInstance) chartInstance.destroy(); return; }

    const labels=vals.map(o=>o.i+1);
    const dataVals=vals.map(o=>o.v);
    const anomalyPoints=vals.map((o,i)=>anomalyFlags[o.i] ? o.v : null);

    const chartData={labels:labels,datasets:[]};
    const type=chartType.value;

    if(type==='line'){
        chartData.datasets.push({label:col,data:dataVals,borderColor:'#106fa4',backgroundColor:'rgba(16,111,164,0.2)',pointRadius:3});
        chartData.datasets.push({label:'Anomalies',data:anomalyPoints,type:'scatter',pointBackgroundColor:'#ff4c4c',pointRadius:6});
    } else if(type==='scatter'){
        chartData.datasets.push({label:col,data:vals.map(o=>({x:o.i+1,y:o.v})),backgroundColor:'#106fa4'});
        chartData.datasets.push({label:'Anomalies',data:vals.filter((o,i)=>anomalyFlags[o.i]).map(o=>({x:o.i+1,y:o.v})),backgroundColor:'#ff4c4c'});
    } else if(type==='bar'){ // histogram
        chartData.datasets.push({label:col,data:dataVals,backgroundColor:vals.map((o,i)=>anomalyFlags[o.i]?'#ff4c4c':'#106fa4')});
    }

    const cfg={type:type==='scatter'?'scatter':type,data:chartData,options:{responsive:true,plugins:{legend:{display:true}},scales:{x:{title:{display:true,text:'Index'}},y:{title:{display:true,text:col}}}}};
    if(chartInstance) chartInstance.destroy();
    chartInstance=new Chart(chartCanvas,cfg);
}

// --- Cleaning & Export ---
function getAnomaliesData(){ return workingData.filter((_,i)=>anomalyFlags[i]); }
function getCleanedData(){ return workingData.filter((_,i)=>!anomalyFlags[i]); }
function downloadCSV(rows,fname){if(!rows||rows.length===0) return; const lines=[header.join(',')]; rows.forEach(r=>{ const line=header.map(c=>{const v=r[c]===undefined||r[c]===null?'':r[c].toString(); return v.includes(',')||v.includes('"')||v.includes('\n')?'"'+v.replace(/"/g,'""')+'"':v; }).join(','); lines.push(line);}); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; a.click();}
</script>
</body>
</html>
